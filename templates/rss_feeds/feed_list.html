{% extends 'base.html' %}
{% load static %}

{% block title %}RSS Feeds - Goal Line Report{% endblock %}

{% block extra_css %}
<style>
    .feed-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .feed-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .feed-source-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .unread-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #667eea;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary">RSS Feeds</h1>
            <p class="lead">Latest football news from top sources</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Feeds</h5>
                    <h3>{{ total_feeds }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Unread</h5>
                    <h3>{{ unread_feeds }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Sources</h5>
                    <h3>{{ sources.count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Categories</h5>
                    <h3>{{ categories.count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="source" class="form-label">Source</label>
                <select name="source" id="source" class="form-select">
                    <option value="">All Sources</option>
                    {% for source in sources %}
                        <option value="{{ source.source_type }}" {% if current_source == source.source_type %}selected{% endif %}>
                            {{ source.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="category" class="form-label">Category</label>
                <select name="category" id="category" class="form-select">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input type="text" name="search" id="search" class="form-control" 
                       value="{{ current_search }}" placeholder="Search feeds...">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="form-check">
                    <input type="checkbox" name="unread" value="true" class="form-check-input" 
                           id="unread" {% if unread_only %}checked{% endif %}>
                    <label class="form-check-label" for="unread">
                        Unread only
                    </label>
                </div>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'rss_feeds:feed_list' %}" class="btn btn-secondary">Clear</a>
            </div>
        </form>
    </div>

    <!-- Feed Items -->
    <div class="row">
        {% for feed in page_obj %}
            <div class="col-lg-6 col-md-12 mb-4">
                <div class="card feed-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge bg-secondary feed-source-badge">
                                {{ feed.source.name }}
                            </span>
                            <small class="text-muted">
                                {{ feed.published_date|timesince }} ago
                            </small>
                        </div>
                        
                        <h5 class="card-title">
                            {% if not feed.is_read %}
                                <span class="unread-indicator"></span>
                            {% endif %}
                            <a href="{% url 'rss_feeds:feed_detail' feed.id %}" class="text-decoration-none">
                                {{ feed.short_title }}
                            </a>
                        </h5>
                        
                        <p class="card-text text-muted">
                            {{ feed.short_description }}
                        </p>
                        
                        {% if feed.author %}
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> {{ feed.author }}
                                </small>
                            </p>
                        {% endif %}
                        
                        {% if feed.category %}
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-tag"></i> {{ feed.category }}
                                </small>
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ feed.link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Read Original
                            </a>
                            <div class="btn-group" role="group">
                                {% if not feed.is_read %}
                                    <button class="btn btn-sm btn-outline-success mark-read-btn" 
                                            data-feed-id="{{ feed.id }}">
                                        <i class="fas fa-check"></i> Mark Read
                                    </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-secondary archive-btn" 
                                        data-feed-id="{{ feed.id }}">
                                    <i class="fas fa-archive"></i> Archive
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-rss fa-3x text-muted mb-3"></i>
                    <h4>No feeds found</h4>
                    <p class="text-muted">Try adjusting your filters or check back later for new content.</p>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <nav aria-label="Feed pagination">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if current_source %}&source={{ current_source }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if unread_only %}&unread=true{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if unread_only %}&unread=true{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if unread_only %}&unread=true{% endif %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if unread_only %}&unread=true{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if current_source %}&source={{ current_source }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if unread_only %}&unread=true{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Mark as read functionality
    $('.mark-read-btn').click(function() {
        const feedId = $(this).data('feed-id');
        const button = $(this);
        
        $.post(`/rss/feed/${feedId}/mark-read/`, {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        })
        .done(function() {
            button.closest('.feed-card').find('.unread-indicator').remove();
            button.remove();
        })
        .fail(function() {
            alert('Failed to mark as read');
        });
    });
    
    // Archive functionality
    $('.archive-btn').click(function() {
        const feedId = $(this).data('feed-id');
        const card = $(this).closest('.feed-card');
        
        if (confirm('Are you sure you want to archive this feed?')) {
            $.post(`/rss/feed/${feedId}/archive/`, {
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            })
            .done(function() {
                card.fadeOut();
            })
            .fail(function() {
                alert('Failed to archive feed');
            });
        }
    });
});
</script>
{% endblock %}
