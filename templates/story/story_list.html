{% extends 'base.html' %}
{% load static %}

{% block title %}Stories - Goal Line Report{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-5">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h1 class="page-title">Stories</h1>
        <p class="page-subtitle">Discover inspiring stories from our community</p>
      </div>
    </div>
  </div>
</div>

<!-- Search & Filter (ONE unified form) -->
<div class="container mb-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="get" class="row g-3 align-items-end">
            <!-- Search -->
            <div class="col-md-6">
              <label for="search" class="form-label">Search Stories (Title) </label>
              <input
                type="text"
                id="search"
                name="search"
                class="form-control"
                placeholder="Search by title,  tag..."
                value="{{ search_query|default:'' }}"
              />
            </div>

            <!-- Dropdown -->
            <div class="col-md-4">
              <label for="tag" class="form-label">Quick Select</label>
              <select id="tag" name="tag" class="form-select" onchange="this.form.submit()">
                {% for t in tags %}
                  <option value="{{ t }}"
                    {% if tag_query and tag_query|lower == t|lower %}selected{% endif %}>
                    {{ t }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Submit -->
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">Search</button>
            </div>

            <!-- Active filter chips -->
            <div class="col-12">
              {% if search_query or tag_query or title_keyword %}
                <div class="mt-2">
                  {% if search_query %}
                    <span class="badge bg-primary me-2">Search: {{ search_query }}</span>
                  {% endif %}
                  {% if tag_query %}
                    <span class="badge bg-secondary me-2">Tag: {{ tag_query }}</span>
                  {% endif %}
                  {% if title_keyword %}
                    <span class="badge bg-info me-2">Title contains: {{ title_keyword }}</span>
                  {% endif %}
                  <a class="btn btn-sm btn-outline-secondary ms-1" href="{% url 'main:stories' %}">Clear</a>
                </div>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stories List -->
<div class="container">
  {% if stories %}
    {% for story in stories %}
      <div class="story-item mb-5 pb-4 border-bottom">
        <!-- Image -->
        <img
          src="{% if story.image %}{{ story.image.url }}{% else %}{% static 'images/default.jpg' %}{% endif %}"
          alt="{{ story.title }}"
          class="img-fluid w-100 rounded mb-3"
          style="max-height: 420px; object-fit: cover;"
        />

        <!-- Title -->
        <h2 class="h4 mb-2">
          <a href="{% url 'story:story_detail' slug=story.slug %}" class="text-decoration-none">
            {{ story.title }}
          </a>
        </h2>

        <!-- Meta -->
        <p class="text-muted small mb-2">
          <i class="fas fa-user"></i> {{ story.author.username }}
          <i class="fas fa-calendar ms-3"></i> {{ story.created_at|date:"F j, Y" }}
          <i class="fas fa-eye ms-3"></i> {{ story.views_count }}
          <i class="fas fa-heart ms-2"></i> {{ story.likes_count }}
        </p>

        <!-- Tag badges (click → ?tag=NAME so it title-filters) -->
        {% with story.tags.all as tag_list %}
          {% if tag_list %}
            <div class="mb-2">
              {% for t in tag_list %}
                <a href="{% url 'main:stories' %}?tag={{ t.name }}"
                   class="badge bg-secondary text-decoration-none tag-hover me-1 mb-1">
                  {{ t.name }}
                </a>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Excerpt -->
        <p class="mb-3">
          {% if story.summary %}
            {{ story.summary|truncatewords:40 }}
          {% else %}
            {{ story.content|truncatewords:40 }}
          {% endif %}
        </p>

        <!-- Read more -->
        <a href="{% url 'story:story_detail' slug=story.slug %}" class="btn btn-outline-primary btn-sm">
          Read Full Story →
        </a>
      </div>
    {% endfor %}
  {% else %}
    <div class="row">
      <div class="col-12 text-center">
        <div class="empty-state py-5">
          <i class="fas fa-book-open fa-4x text-muted mb-4"></i>
          <h3>No Stories Found</h3>
          <p class="text-muted">
            Try adjusting your search or choose a different tag.
          </p>
          {% if user.is_authenticated %}
            <a href="{% url 'story:story_create' %}" class="btn btn-primary">Write Your First Story</a>
          {% else %}
            <a href="#" data-bs-toggle="modal" data-bs-target="#signupModal" class="btn btn-primary">
              Join and Share Your Story
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Hover effect CSS -->
<style>
  .tag-hover {
    transition: all 0.2s ease;
  }
  .tag-hover:hover {
    background-color: #0d6efd;
    color: #fff !important;
    transform: translateY(-1px);
  }
</style>
{% endblock %}
